---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# ヤフー・データソリューションの「東京23区滞在人口推計値の日別遷移（全体・来訪者・住人）」をRでプロットしてみる

## データの出典

* 東京23区滞在人口推計値の日別遷移データ: ヤフー・データソリューション (<https://ds.yahoo.co.jp/report/>)
* 行政区域データ: 国土数値情報 (<http://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-v2_3.html>)
* 祝日データ: zipangu (<https://uribo.github.io/zipangu/>)

## Plot

```{r library}
library(readr)
library(ggplot2)
library(sf)
library(dplyr, warn.conflicts = FALSE)
```

```{r load_data}
# 前処理の詳細は scripts/get_data.R
d <- readr::read_csv(here::here("data/data.csv"))
```

```{r plot_simple}
ggplot(d, aes(date, visitors, colour = 対象分類, fill = 対象分類)) +
  geom_area() +
  facet_wrap(vars(エリア), ncol = 4) +
  scale_colour_viridis_d(alpha = 0.3, aesthetics = c("colour", "fill")) +
  scale_x_date(guide = guide_axis(n.dodge = 2), date_labels = "%m/%d") +
  theme_minimal() +
  theme(legend.position = "top")
```

```{r load_tokyo}
# 前処理の詳細は scripts/get_tokyo_gpkg.R
tokyo <- read_sf(here::here("data/tokyo.gpkg"))

d2 <- d %>%
  mutate(
    is_holiday = zipangu::is_jholiday(date) | (lubridate::wday(date) %in% 6:7),
    week_begin = lubridate::floor_date(date, "weeks"),
    day = lubridate::wday(date, label = TRUE)
  ) %>% 
  inner_join(tokyo, ., by = c("市区町村名" = "エリア"))
```

```{r plot_first_week}
d2 %>%
  filter(week_begin == as.Date("2020-02-02")) %>% 
  ggplot() +
  geom_sf(aes(fill = visitors), colour = NA) +
  facet_grid(rows = vars(対象分類), cols = vars(day)) +
  theme_minimal() +
  theme(legend.position = "top") +
  ggtitle("2020/2/2〜2/8")
```


```{r plot_changes}
d_mean <- d2 %>%
  group_by(市区町村名, 対象分類, is_holiday = if_else(is_holiday, "holiday", "weekday"), week_begin) %>%
  summarise(visitors = mean(visitors)) %>%
  arrange(week_begin) %>%
  mutate(rel_visitors = visitors / first(visitors)) %>%
  ungroup()

ggplot(d_mean, aes(week_begin, rel_visitors, colour = 市区町村名)) +
  geom_line() +
  facet_grid(rows = vars(is_holiday, 対象分類))
```

